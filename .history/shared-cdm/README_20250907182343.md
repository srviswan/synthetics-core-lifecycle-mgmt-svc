# Shared CDM Module

This module contains the Common Data Model (CDM) classes and shared services for the Swap Life Cycle Management Service.

## Components

### Domain Objects
- **Party**: Counterparty information
- **Underlier**: Underlying asset information
- **Trade**: Swap trade information
- **Position**: Position within a trade
- **Lot**: Individual lot within a position
- **Cashflow**: Generated cashflow information

### Events
- **LifecycleEvent**: Base class for all lifecycle events
- **NewTradeEvent**: New trade creation event
- **AmendmentEvent**: Trade amendment event
- **PartialUnwindEvent**: Partial unwind event
- **TerminationEvent**: Trade termination event
- **FixingPublishedEvent**: Market data fixing event

### Messaging
- **EventPublisher**: Interface for publishing events
- **EventConsumer**: Interface for consuming events
- **EventHandler**: Functional interface for event handling
- **EventProcessingException**: Exception for event processing errors

### Infrastructure Services (`com.synthetics.core.infra`)

#### Resilience (`com.synthetics.core.infra.resilience`)
- **CircuitBreakerService**: Circuit breaker for resilience patterns
- **RetryService**: Retry mechanism for external service calls

#### Cache (`com.synthetics.core.infra.cache`)
- **CacheService**: In-memory caching with TTL support

#### Validation (`com.synthetics.core.infra.validation`)
- **ValidationService**: Business rules and data validation

#### Audit (`com.synthetics.core.infra.audit`)
- **AuditService**: Comprehensive audit logging

#### Metrics (`com.synthetics.core.infra.metrics`)
- **MetricsService**: Business and technical metrics collection

#### Reference Data (`com.synthetics.core.infra.reference`)
- **ReferenceDataService**: Interface for reference data access
- **MockReferenceDataService**: Mock implementation for development
- **RealReferenceDataService**: Real implementation (placeholder)

## Reference Data Service

The reference data service provides access to market data, calendars, and party information.

### Configuration

```yaml
reference-data:
  service:
    type: mock  # Options: mock, real
  mock:
    enabled: true
  real:
    enabled: false
```

### Usage

```java
@Autowired
private ReferenceDataService referenceDataService;

// Get interest rate curve
CompletableFuture<InterestRateCurve> curve = 
    referenceDataService.getInterestRateCurve("USD-LIBOR", LocalDate.now());

// Get fixing value
CompletableFuture<Fixing> fixing = 
    referenceDataService.getFixing("LIBOR-USD-3M", LocalDate.now());

// Get business calendar
CompletableFuture<Calendar> calendar = 
    referenceDataService.getBusinessCalendar("USD");

// Get party information
CompletableFuture<Party> party = 
    referenceDataService.getParty("BANK001");
```

### Mock Implementation

The mock implementation provides:
- **Interest Rate Curves**: Predefined rates for different tenors
- **Fixings**: Random values based on index type
- **Business Calendar**: Monday-Friday with common holidays
- **Parties**: Predefined party information

### Real Implementation

The real implementation is a placeholder that can be extended to integrate with actual reference data systems.

## Shared Services

### Circuit Breaker Service
Provides circuit breaker functionality for external service calls:

```java
@Autowired
private CircuitBreakerService circuitBreakerService;

// Execute with circuit breaker protection
CompletableFuture<Result> result = circuitBreakerService.executeWithCircuitBreaker(
    "reference-data", () -> referenceDataService.getData(key));
```

### Retry Service
Provides retry mechanism for failed operations:

```java
@Autowired
private RetryService retryService;

// Execute with retry protection
CompletableFuture<Result> result = retryService.executeWithRetry(
    "database", () -> databaseService.save(data));
```

### Cache Service
Provides in-memory caching with TTL support:

```java
@Autowired
private CacheService cacheService;

// Get or compute with caching
CompletableFuture<Data> data = cacheService.getOrCompute(
    "key", () -> expensiveOperation(), Duration.ofMinutes(10));
```

### Validation Service
Provides centralized validation logic:

```java
@Autowired
private ValidationService validationService;

// Validate trade
List<String> errors = validationService.validateTrade(trade);
if (validationService.hasErrors(errors)) {
    // Handle validation errors
}
```

### Audit Service
Provides comprehensive audit logging:

```java
@Autowired
private AuditService auditService;

// Log operation start
auditService.logOperationStart("CASHFLOW_GENERATION", tradeId, userId, metadata);

// Log operation completion
auditService.logOperationComplete("CASHFLOW_GENERATION", tradeId, userId, true, metadata);
```

### Metrics Service
Provides business and technical metrics:

```java
@Autowired
private MetricsService metricsService;

// Record trade processing metrics
metricsService.recordTradeProcessing(tradeId, processingTime, positionCount, cashflowCount);

// Record error metrics
metricsService.recordError("VALIDATION_ERROR", "TradeService", "HIGH");
```

## Dependencies

- Spring Boot Starter
- Jackson for JSON serialization
- Validation API
- Lombok for code generation
- Spring Boot Configuration Processor
- Resilience4j for circuit breaker and retry
- Micrometer for metrics

## Usage in Services

To use the shared CDM in other services:

1. Add dependency to `shared-cdm`
2. Import the required classes
3. Configure the reference data service
4. Use the domain objects and services

Example:

```xml
<dependency>
    <groupId>com.synthetics.core</groupId>
    <artifactId>shared-cdm</artifactId>
    <version>${project.version}</version>
</dependency>
```
